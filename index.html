<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Fantasy Leaderboard</title>
<style>
  :root{ --bg:#0b0d10; --card:#12161b; --muted:#8ea0b3; --text:#e8eef4; --br:#1b232d; }
  html,body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  header{display:flex;gap:12px;align-items:center;flex-wrap:wrap;padding:14px 18px;border-bottom:1px solid var(--br);background:#0f1318}
  h1{margin:0;font-size:18px}
  .sub{color:var(--muted);font-size:13px}
  main{max-width:980px;margin:0 auto;padding:18px;display:grid;gap:16px}
  .panel{background:var(--card);border:1px solid var(--br);border-radius:14px;padding:14px}
  .titleRow{display:flex;justify-content:space-between;align-items:center;gap:10px}
  .muted{color:var(--muted);font-size:12px}
  .tableWrap{overflow:auto;border:1px solid var(--br);border-radius:12px;margin-top:10px}
  table{border-collapse:separate;border-spacing:0;width:100%;min-width:420px;background:#0f1318}
  thead th{position:sticky;top:0;background:#101722;border-bottom:1px solid #243241;font-weight:700;text-align:left;padding:10px}
  tbody td{padding:10px;border-top:1px solid #1b2430}
  tbody tr:hover{background:#111b24}
  .num{text-align:right;font-variant-numeric:tabular-nums}
  .badge{display:inline-block;background:#101722;border:1px solid #253548;border-radius:8px;padding:2px 6px;margin-left:6px;font-size:12px}
  .error{color:#ffb4b4}
</style>
</head>
<body>
<header>
  <h1>Leaderboards</h1>
  <span class="sub" id="updated">—</span>
</header>

<main id="boards">
  <!-- Panels injected here -->
</main>

<script>
const FILE = 'leaderboard.json'; // same directory
const $ = id => document.getElementById(id);

// Known sections in preferred order
const ORDER = [
  ['nflWeek',   'NFL — This Week'],
  ['ncaaWeek',  'NCAA — This Week'],
  ['nflSeason', 'NFL — Season'],
  ['ncaaSeason','NCAA — Season']
];

function esc(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function fmt(x){ return (typeof x === 'number' && isFinite(x)) ? x.toFixed(2) : '0.00'; }

function normalizeRows(list){
  if (!Array.isArray(list)) return [];
  return list.map(r => ({
    name: String(r.name ?? r.player ?? '—'),
    total: Number(r.total ?? r.points ?? 0) || 0,
    picks: (typeof r.picks === 'number') ? r.picks : null
  }));
}

function renderBoard(container, title, rows){
  // sort by points desc
  rows.sort((a,b) => b.total - a.total);

  // determine if any row has picks; if none, hide that column
  const showPicks = rows.some(r => typeof r.picks === 'number');

  const panel = document.createElement('section');
  panel.className = 'panel';
  panel.innerHTML = `
    <div class="titleRow">
      <h2 style="margin:0;font-size:16px">${esc(title)}</h2>
      <span class="muted">${rows.length} players</span>
    </div>
    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th style="min-width:220px">Name</th>
            <th class="num" style="width:120px">Points</th>
            ${showPicks ? '<th class="num" style="width:100px">Picks</th>' : ''}
          </tr>
        </thead>
        <tbody>
          ${rows.map(r => `
            <tr>
              <td>${esc(r.name)}${showPicks && typeof r.picks === 'number' ? ` <span class="badge">${r.picks}/3</span>` : ''}</td>
              <td class="num">${fmt(r.total)}</td>
              ${showPicks ? `<td class="num">${typeof r.picks === 'number' ? r.picks : '—'}</td>` : ''}
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;
  container.appendChild(panel);
}

function setUpdated(ts){
  try{
    if (!ts) { $('updated').textContent = 'Updated: —'; return; }
    const d = new Date(ts);
    $('updated').textContent = 'Updated: ' + d.toLocaleString([], {hour:'2-digit',minute:'2-digit',month:'short',day:'numeric'});
  }catch(e){ $('updated').textContent = 'Updated: —'; }
}

(async function init(){
  const wrap = document.getElementById('boards');
  wrap.innerHTML = '<section class="panel"><div class="muted">Loading leaderboard…</div></section>';

  try{
    const res = await fetch(FILE, {cache:'no-store'});
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const json = await res.json();

    setUpdated(json.updated);

    // Collect panels to show (in ORDER). Also allow fallback if JSON is just an array.
    const panels = [];
    for (const [key, label] of ORDER){
      const rows = normalizeRows(json[key]);
      if (rows.length) panels.push([label, rows]);
    }
    if (!panels.length && Array.isArray(json)){
      const rows = normalizeRows(json);
      if (rows.length) panels.push(['Leaderboard', rows]);
    }

    // Render
    wrap.innerHTML = '';
    if (!panels.length){
      wrap.innerHTML = '<section class="panel"><div class="error">No leaderboard data found.</div></section>';
      return;
    }
    for (const [label, rows] of panels){
      renderBoard(wrap, label, rows);
    }
  }catch(err){
    wrap.innerHTML = `<section class="panel"><div class="error">Failed to load leaderboard.json: ${esc(err.message)}</div></section>`;
  }
})();
</script>
</body>
</html>
