<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Fantasy Leaderboard</title>
<style>
  :root{ --bg:#0b0d10; --card:#12161b; --muted:#8ea0b3; --text:#e8eef4; --br:#1b232d; }
  html,body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  header{display:flex;gap:12px;align-items:center;flex-wrap:wrap;padding:14px 18px;border-bottom:1px solid var(--br);background:#0f1318}
  h1{margin:0;font-size:18px}
  .sub{color:var(--muted);font-size:13px}
  main{max-width:900px;margin:0 auto;padding:18px}
  .panel{background:var(--card);border:1px solid var(--br);border-radius:14px;padding:14px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  select,button{background:#0b1117;border:1px solid #1b2633;border-radius:8px;color:var(--text);padding:8px 10px;font-size:14px}
  button{cursor:pointer}
  .muted{color:var(--muted);font-size:12px}
  .tableWrap{overflow:auto;border:1px solid var(--br);border-radius:12px}
  table{border-collapse:separate;border-spacing:0;width:100%;min-width:420px;background:#0f1318}
  thead th{position:sticky;top:0;background:#101722;border-bottom:1px solid #243241;font-weight:700;text-align:left;padding:10px}
  tbody td{padding:10px;border-top:1px solid #1b2430}
  tbody tr:hover{background:#111b24}
  .num{text-align:right;font-variant-numeric:tabular-nums}
  .badge{display:inline-block;background:#101722;border:1px solid #253548;border-radius:8px;padding:2px 6px;margin-left:6px;font-size:12px}
  .sep{height:1px;background:var(--br);margin:12px 0}
  .error{color:#ffb4b4}
</style>
</head>
<body>
<header>
  <h1>Leaderboards</h1>
  <span class="sub" id="updated">—</span>
  <span style="flex:1"></span>
  <button id="reloadBtn" title="Reload JSON">Reload</button>
</header>

<main>
  <section class="panel">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <label for="boardSel" class="muted">Board</label>
        <select id="boardSel"></select>
      </div>
      <div class="row">
        <input id="filter" type="text" placeholder="Filter by name" style="background:#0b1117;border:1px solid #1b2633;border-radius:8px;color:var(--text);padding:8px 10px" />
      </div>
    </div>
    <div class="sep"></div>
    <div class="tableWrap">
      <table id="tbl">
        <thead>
          <tr>
            <th style="min-width:220px;cursor:pointer" data-sort="name">Name</th>
            <th class="num" style="width:120px;cursor:pointer" data-sort="total">Points</th>
            <th class="num" style="width:100px;cursor:pointer" data-sort="picks">Picks</th>
          </tr>
        </thead>
        <tbody id="tbody"><tr><td colspan="3" class="muted">Loading…</td></tr></tbody>
      </table>
    </div>
    <div id="note" class="muted" style="margin-top:10px">—</div>
    <div id="err" class="error" style="margin-top:8px;display:none"></div>
  </section>
</main>

<script>
/*
Expected leaderboard.json (flexible):
{
  "updated": "2025-09-07T19:30:00Z",
  "nflWeek":   [ { "name":"Jake", "total":12.5, "picks":3 }, ... ],
  "ncaaWeek":  [ { "name":"AI Alpha", "total":9.75, "picks":3 }, ... ],
  "nflSeason": [ { "name":"Jake", "points":42 }, ... ],
  "ncaaSeason":[ { "name":"AI Alpha", "points":37 }, ... ]
}
Notes:
- Uses "total" or "points" for score (both supported)
- "picks" is optional (season rows may not have it)
*/

const FILE = 'leaderboard.json'; // same directory
const $ = (id)=>document.getElementById(id);
const state = {
  raw:null,
  boards:[],          // [{key,label}]
  rows:[],            // current board rows
  sort:{ key:'total', dir:'desc' }
};

const LABELS = {
  nflWeek:'NFL — This Week',
  ncaaWeek:'NCAA — This Week',
  nflSeason:'NFL — Season',
  ncaaSeason:'NCAA — Season'
};

function fmtPoints(x){
  if (typeof x !== 'number' || !isFinite(x)) return '0.00';
  return x.toFixed(2);
}

function normalizeRows(list){
  if (!Array.isArray(list)) return [];
  return list.map(r=>({
    name: String(r.name ?? r.player ?? '—'),
    total: Number((r.total ?? r.points ?? 0)) || 0,
    picks: (r.picks ?? null)
  }));
}

function detectBoards(json){
  const keys = ['nflWeek','ncaaWeek','nflSeason','ncaaSeason'];
  const out = [];
  for (const k of keys){
    if (Array.isArray(json[k]) && json[k].length){
      out.push({key:k, label:LABELS[k]});
    }
  }
  // if nothing matched, but json is an array, treat as a generic board
  if (!out.length && Array.isArray(json)){
    return [{key:'_generic', label:'Leaderboard'}];
  }
  return out;
}

function setUpdated(ts){
  try{
    if (!ts) { $('updated').textContent = 'Updated: —'; return; }
    const d = new Date(ts);
    $('updated').textContent = 'Updated: ' + d.toLocaleString([], {hour:'2-digit',minute:'2-digit',month:'short',day:'numeric'});
  }catch(e){ $('updated').textContent = 'Updated: —'; }
}

function fillBoardSelector(){
  const sel = $('boardSel');
  sel.innerHTML = '';
  state.boards.forEach((b,i)=>{
    const o = document.createElement('option');
    o.value = b.key;
    o.textContent = b.label;
    sel.appendChild(o);
  });
}

function applyFilter(rows){
  const q = ($('filter').value || '').trim().toLowerCase();
  if (!q) return rows;
  return rows.filter(r => r.name.toLowerCase().includes(q));
}

function renderTable(){
  const tbody = $('tbody');
  const rows = applyFilter(state.rows).slice();
  const {key,dir} = state.sort;

  rows.sort((a,b)=>{
    let av = a[key], bv = b[key];
    if (key === 'name'){
      av = String(av).toLowerCase();
      bv = String(bv).toLowerCase();
      if (av < bv) return dir==='asc' ? -1 : 1;
      if (av > bv) return dir==='asc' ? 1 : -1;
      return 0;
    } else {
      // numeric
      return dir==='asc' ? (av - bv) : (bv - av);
    }
  });

  tbody.innerHTML = '';
  if (!rows.length){
    tbody.innerHTML = '<tr><td colspan="3" class="muted">No entries.</td></tr>';
    return;
  }

  for (const r of rows){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(r.name)}${typeof r.picks === 'number' ? ` <span class="badge">${r.picks}/3</span>` : ''}</td>
      <td class="num">${fmtPoints(r.total)}</td>
      <td class="num">${typeof r.picks === 'number' ? r.picks : '—'}</td>
    `;
    tbody.appendChild(tr);
  }
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

function selectBoard(key){
  let rows = [];
  if (key === '_generic'){
    rows = normalizeRows(state.raw);
  } else {
    rows = normalizeRows(state.raw[key]);
  }
  state.rows = rows;
  $('note').textContent = `${rows.length} players`;
  renderTable();
}

async function loadJSON(){
  $('err').style.display='none';
  $('tbody').innerHTML = '<tr><td colspan="3" class="muted">Loading…</td></tr>';
  $('note').textContent = '—';
  try{
    const res = await fetch(FILE, {cache:'no-store'});
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const json = await res.json();

    state.raw = json;
    state.boards = detectBoards(json);
    if (!state.boards.length){
      throw new Error('No leaderboard data found in JSON');
    }

    fillBoardSelector();
    const firstKey = new URLSearchParams(location.search).get('board') || state.boards[0].key;
    $('boardSel').value = firstKey;
    selectBoard(firstKey);
    setUpdated(json.updated);
  }catch(err){
    $('err').textContent = 'Failed to load leaderboard.json: ' + err.message;
    $('err').style.display = 'block';
    $('tbody').innerHTML = '<tr><td colspan="3" class="muted">—</td></tr>';
  }
}

function onHeaderClick(ev){
  const th = ev.target.closest('[data-sort]');
  if (!th) return;
  const key = th.getAttribute('data-sort');
  if (state.sort.key === key){
    state.sort.dir = state.sort.dir === 'asc' ? 'desc' : 'asc';
  } else {
    state.sort.key = key;
    state.sort.dir = key === 'name' ? 'asc' : 'desc';
  }
  renderTable();
}

$('boardSel').addEventListener('change', (e)=> selectBoard(e.target.value));
$('filter').addEventListener('input', ()=> renderTable());
$('reloadBtn').addEventListener('click', ()=> loadJSON());
document.querySelector('thead').addEventListener('click', onHeaderClick);

loadJSON();
</script>
</body>
</html>
